<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<html lang="ko">
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Example Home</title>
	
	<link rel="stylesheet" href="/css/home.css">
	
</head>

<body>
	<div class="main-container">

		<div class="container">
			<!-- 상단 패널 (검색과 검색 결과) -->
			<div class="top-panel">
				<!-- 검색 패널 -->
				<div class="search-panel">

					<!-- 달력 영역 추가 -->
					<div class="calendar-panel">
						<div class="calendar-header">
							<button id="prev-month">&lt;</button>
							<span id="calendar-title"></span>
							<button id="next-month">&gt;</button>
						</div>
						<table>
							<thead>
								<tr>
									<th>일</th>
									<th>월</th>
									<th>화</th>
									<th>수</th>
									<th>목</th>
									<th>금</th>
									<th>토</th>
								</tr>
							</thead>
							<tbody id="calendar-body"></tbody> <!-- 달력이 렌더링될 영역 -->
						</table>
					</div>

					<div class="input-section">
						<label for="pId">환자 ID</label>
						<input type="text" id="pId" name="pId" placeholder="환자 ID를 입력하세요">

						<label for="pName">환자 이름</label>
						<input type="text" id="pName" name="pName" placeholder="환자 이름을 입력하세요">

						<div class="date-range-container">
							<label for="startDate">검사일자</label>
							<input type="date" id="startDate">
							<span>~</span>
							<input type="date" id="endDate">
						</div>

						<div class="quick-range-buttons">
							<button id="one-day-btn">1일</button>
							<button id="three-day-btn">3일</button>
							<button id="week-btn">1주일</button>
						</div>

						<div class="buttons">
							<button class="search-btn">조회</button>
							<button class="reset-btn" id="reset-btn">재설정</button>
						</div>
					</div>
				</div>

				<div class="right-panel">
					<div class="verify-panel">
						<div class="verify-row">
							<div class="verify-item">
								<label for="modality">검사장비</label>
								<select id="modality" name="modality" th:value="${modality != null ? modality : ''}">
									<option value="">선택해주세요</option>
									<option value="AS">AS</option>
									<option value="AU">AU</option>
									<option value="BI">BI</option>
									<option value="CD">CD</option>
									<option value="CF">CF</option>
									<option value="CP">CP</option>
									<option value="CR">CR</option>
									<option value="CS">CS</option>
									<option value="CT">CT</option>
									<option value="DD">DD</option>
									<option value="DF">DF</option>
									<option value="DG">DG</option>
									<option value="DM">DM</option>
									<option value="DR">DR</option>
									<option value="DS">DS</option>
									<option value="DX">DX</option>
									<option value="EC">EC</option>
									<option value="ES">ES</option>
									<option value="FA">FA</option>
									<option value="FS">FS</option>
									<option value="LS">LS</option>
									<option value="LP">LP</option>
									<option value="MA">MA</option>
									<option value="MR">MR</option>
									<option value="MS">MS</option>
									<option value="NM">NM</option>
									<option value="OT">OT</option>
									<option value="PT">PT</option>
									<option value="RF">RF</option>
									<option value="RG">RG</option>
									<option value="ST">ST</option>
									<option value="TG">TG</option>
									<option value="US">US</option>
									<option value="VF">VF</option>
									<option value="XA">XA</option>
								</select>
							</div>
							<div class="verify-item">
								<label for="verifyFlag">Verify</label>
								<select id="verifyFlag" th:value="${verifyFlag != null ? verifyFlag : ''}">
									<option value="">선택하세요</option> <!-- 선택되지 않음 -->
									<option value="0">미요청</option>
									<option value="1">요청완료</option>
								</select>
							</div>
							<div class="verify-item">
								<label for="reportStatus">판독 상태</label>
								<select id="reportStatus" name="reportStatus"
									th:value="${reportStatus != null ? reportStatus : ''}">
									<option value="">선택하세요</option> <!-- 선택하지 않음 -->
									<option value="3">읽지 않음</option>
									<option value="5">예비 판독</option>
									<option value="6">판독</option>
								</select>
							</div>
							<div class="patient-info">
								<div class="patient-id">
									<label>환자 ID : </label>
									<span id="patient-id-item"></span>
								</div>
								<div class="patient-name">
									<label>환자 이름 : </label>
									<span id="patient-name-item"></span>
								</div>
							</div>
						</div>
					</div>

					<div class="inspections-panel">
						<div class="inspections-row">
							<div class="inspections-item">
								<label>총 검사 건수 : </label>
								<span id="inspections">0</span>
							</div>
							<div class="right-controls">
								<div class="download-panel">
									<button class="download-btn" id="dicom-download-btn">DICOM 다운로드</button>
									<button class="download-btn" id="image-download-btn">이미지 다운로드</button>
									<button class="download-btn" id="delete-btn">검사 삭제</button>
								</div>
								<!-- <div class="select-panel2">
									<select id="view-select">
										<option value="all">보기 선택</option>
										<option value="20">20개씩 보기</option>
										<option value="50">50개씩 보기</option>
										<option value="100">100개씩 보기</option>
									</select>
								</div> -->
							</div>
						</div>
					</div>

					<!-- 검색 결과 패널 -->
					<div class="result-panel">
						<div class="result-table">
							<div class="result-table-container">
								<div class="result-table-thead">
									<span>환자 ID</span> <span>환자 이름</span> <span>검사 장비</span> <span>검사
										설명</span> <span>검사 일시</span> <span>판독 상태</span> <span>시리즈</span>
									<span>이미지</span>
									<span>Verify</span>
								</div>
								<div class="result-table-result">
									<!-- 검색 결과 출력 -->
								</div>
								<button id="load-more-btn" style="display: none;">더보기</button>
							</div>
						</div>
					</div>
				</div>

			</div>

			<!-- 하단 패널 (과거 검사 이력 및 Study 정보) -->
			<div class="bottom-panels">
				<!-- 과거 검사 이력 -->
				<div class="history-panel">
					<h3>과거 검사 이력</h3>
					<div class="history-name">
						<div class="history-id">
							<label>환자 ID : </label>
							<span id="history-patient-id"></span>
						</div>
						<div class="history-name-item">
							<label>환자 이름 : </label>
							<span id="history-patient-name"></span>
						</div>
					</div>
					<div class="history-info-container">

						<div class="history-table">

							<div class="history-table-thead">
								<span>검사 장비</span>
								<span>검사 설명</span>
								<span>검사 일시</span>
								<span>판독 상태</span>
								<span>시리즈</span>
								<span>Verify</span>
							</div>
							<div class="history-table-result">
								<!-- 과거 검사 이력 출력 -->
							</div>
						</div>



					</div>
				</div>

				<!-- 리포트 패널 -->
				<div class="report-panel">
					<h3>리포트 (Study 정보)</h3>
					<div class="study-info-container">
						<div class="ai-content">
							<label>AI 진단 병명</label>
							<div id="aiFinding" class="info-item"></div>

							<label>AI 진단 내용</label>
							<div id="aiReport" class="info-item"></div>
						</div>

						<div class="filming-info">
							<label>수술한 의사</label>
							<div id="operatorsName" class="info-item"></div>

							<label>촬영 방향</label>
							<div id="viewPosition" class="info-item"></div>

							<label>촬영 부위</label>
							<div id="bodyPart" class="info-item"></div>

							<label>검사 설명</label>
							<div id="studyDesc" class="info-item"></div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- 달력 및 기타 스크립트 -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const today = new Date();
        let currentYear = today.getFullYear();
        let currentMonth = today.getMonth();
        let startDate = null;
        let endDate = null;

        // 범위 강조
        function highlightRange(start, end) {
            const calendarBody = document.getElementById("calendar-body");
            const cells = calendarBody.getElementsByTagName("td");
            for (let i = 0; i < cells.length; i++) {
                const cellDate = parseInt(cells[i].textContent);
                const cellFullDate = new Date(currentYear, currentMonth, cellDate);
                if (!isNaN(cellDate) && cellFullDate >= start && cellFullDate <= end) {
                    cells[i].classList.add("highlighted-range");
                } else {
                    cells[i].classList.remove("highlighted-range");
                }
            }
        }

        // 단일 날짜 강조
        function highlightSingleDate(date, className) {
            const calendarBody = document.getElementById("calendar-body");
            const cells = calendarBody.getElementsByTagName("td");
            for (let i = 0; i < cells.length; i++) {
                const cellDate = parseInt(cells[i].textContent);
                const cellFullDate = new Date(currentYear, currentMonth, cellDate);
                if (!isNaN(cellDate) && cellFullDate.getTime() === date.getTime()) {
                    cells[i].classList.add(className);
                } else {
                    cells[i].classList.remove(className);
                }
            }
        }

        // 달력 업데이트
        function updateCalendar() {
            const monthNames = ["1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"];
            document.getElementById("calendar-title").textContent = `${currentYear}년 ${monthNames[currentMonth]}`;

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const lastDate = new Date(currentYear, currentMonth + 1, 0).getDate();
            const calendarBody = document.getElementById("calendar-body");
            calendarBody.innerHTML = "";
            let date = 1;

            for (let i = 0; i < 6; i++) {
                const row = document.createElement("tr");
                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement("td");
                    if (i === 0 && j < firstDay) {
                        cell.textContent = "";
                    } else if (date > lastDate) {
                        break;
                    } else {
                        cell.textContent = date;
                        cell.dataset.date = date;

                        // 클릭 이벤트 추가
                        cell.addEventListener("click", function () {
                            selectDate(cell);
                        });

                        // 현재 날짜 표시
                        if (currentYear === today.getFullYear() && currentMonth === today.getMonth() && date === today.getDate()) {
                            cell.classList.add("current-day");
                        }

                        // 이전 선택 날짜 복원
                        const cellDate = new Date(currentYear, currentMonth, date).getTime();
                        if (startDate && cellDate === startDate.getTime()) {
                            cell.classList.add("selected-date");
                        }
                        if (endDate && cellDate === endDate.getTime()) {
                            cell.classList.add("endDate");
                        }
                        if (startDate && endDate && cellDate >= startDate.getTime() && cellDate <= endDate.getTime()) {
                            cell.classList.add("highlighted-range");
                        }

                        date++;
                    }
                    row.appendChild(cell);
                }
                calendarBody.appendChild(row);
            }
        }

        // 날짜 선택
        function selectDate(cell) {
            const selectedDate = parseInt(cell.dataset.date);

            if (!startDate) {
                startDate = new Date(currentYear, currentMonth, selectedDate);
                cell.classList.add("selected-date");
            } else if (!endDate) {
                endDate = new Date(currentYear, currentMonth, selectedDate);

                if (startDate > endDate) {
                    [startDate, endDate] = [endDate, startDate];
                }

                highlightRange(startDate, endDate);
                cell.classList.add("endDate");

                document.getElementById("startDate").value = formatDate(startDate);
                document.getElementById("endDate").value = formatDate(endDate);
            } else {
                clearSelection();
                startDate = new Date(currentYear, currentMonth, selectedDate);
                cell.classList.add("selected-date");
            }
        }

        // 선택 초기화
        function clearSelection() {
            const calendarBody = document.getElementById("calendar-body");
            const cells = calendarBody.getElementsByTagName("td");
            for (let i = 0; i < cells.length; i++) {
                cells[i].classList.remove("selected-date");
                cells[i].classList.remove("highlighted-range");
                cells[i].classList.remove("endDate");
            }
            startDate = null;
            endDate = null;
        }

        // 검사일자 필드에서 입력 이벤트 처리
        document.getElementById("startDate").addEventListener("input", function () {
            const startInputValue = this.value;
            if (startInputValue) {
                startDate = new Date(startInputValue);
                startDate.setHours(0, 0, 0, 0);
                if (endDate) {
                    highlightRange(startDate, endDate);
                } else {
                    highlightSingleDate(startDate, "selected-date");
                }
                updateCalendar(); // 달력 업데이트
            }
        });

        document.getElementById("endDate").addEventListener("input", function () {
            const endInputValue = this.value;
            if (endInputValue) {
                endDate = new Date(endInputValue);
                endDate.setHours(0, 0, 0, 0);
                if (startDate) {
                    highlightRange(startDate, endDate);
                } else {
                    highlightSingleDate(endDate, "endDate");
                }
                updateCalendar(); // 달력 업데이트
            }
        });

        // 이전/다음 달로 이동
        document.getElementById("prev-month").addEventListener("click", function () {
            currentMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            currentYear = currentMonth === 11 ? currentYear - 1 : currentYear;
            updateCalendar();
        });

        document.getElementById("next-month").addEventListener("click", function () {
            currentMonth = currentMonth === 11 ? 0 : currentMonth + 1;
            currentYear = currentMonth === 0 ? currentYear + 1 : currentYear;
            updateCalendar();
        });

        // 재설정 버튼
        document.getElementById("reset-btn").addEventListener("click", function () {
            document.getElementById("startDate").value = "";
            document.getElementById("endDate").value = "";
            document.getElementById("verifyFlag").value = "";
            document.getElementById("modality").value = "";
            document.getElementById("reportStatus").value = "";
            document.getElementById("pId").value = "";
            document.getElementById("pName").value = "";
            clearSelection();
            updateCalendar();
        });

        // 날짜 포맷 함수
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");
            return `${year}-${month}-${day}`;
        }

        updateCalendar();
    });
</script>


		<script>
			let selectIndex = -1;
			let currentPage = 0;

			// 검색 버튼 클릭 시 호출되는 함수
			document.querySelector(".search-btn").addEventListener("click", function () {
				currentPage = 0;  // 페이지 초기화
				performSearch();
			});

			// 더보기 버튼 클릭 이벤트
			document.getElementById("load-more-btn").addEventListener("click", function () {
				currentPage += 1;  // 다음 페이지 로드
				performSearch();
			});

			function performSearch() {
				const startDate = document.getElementById("startDate").value;
				const endDate = document.getElementById("endDate").value;
				const modality = document.getElementById("modality").value;
				const verifyFlag = document.getElementById("verifyFlag").value;
				const reportStatus = document.getElementById("reportStatus").value;
				const pId = document.getElementById("pId").value;
				const pName = document.getElementById("pName").value;

				axios.post(`/search?page=${currentPage}`, {
					pId: pId,
					pName: pName,
					modality: modality,
					startDate: startDate,
					endDate: endDate,
					reportStatus: reportStatus,
					verifyFlag: verifyFlag
				})
					.then(result => {
						const studies = result.data.content;  // 현재 페이지 데이터
						const totalPages = result.data.totalPages;
						const totalElements = result.data.totalElements;	// 총 검사 건수
						const studyResultContainer = document.querySelector(".result-table-result");

						// 총 검사 건수를 #inspections에 표시
						document.getElementById("inspections").innerHTML = totalElements;

						if (currentPage === 0) {
							studyResultContainer.innerHTML = "";  // 첫 페이지일 때 기존 내용 초기화
						}

						studies.forEach((study, i) => {
							
							const row = document.createElement("div");
							row.classList.add('result-table-tbody');
							row.classList.add(`selected${currentPage}${i}`);
							if (i % 2 === 1) row.classList.add('odd');
							
							row.innerHTML = `
								<span>${study.pid}</span>
								<span>${study.pname}</span>
								<span>${study.modality}</span>
								<span>${study.studyDesc}</span>
								<span>${study.studyDate}</span>
								<span>${study.reportStatus === 3 ? '읽지않음' : (study.reportStatus === 5 ? '예비판독' : (study.reportStatus === 6 ? '판독' : '알수없음'))}</span>
								<span>${study.seriesCnt}</span>
								<span>${study.imageCnt}</span>
								<span>${study.verifyFlag === 0 ? '미요청' : (study.verifyFlag === 1 ? '요청완료' : '알 수 없음')}</span>
							`;

							// 클릭 시, 환자 ID, 환자 이름 업데이트 이벤트 추가
							row.addEventListener('click', function () {
								document.getElementById("patient-id-item").textContent = study.pid;
								document.getElementById("patient-name-item").textContent = study.pname;
							});
					
							row.addEventListener('dblclick', function () {
								location.href = `/series?studyKey=${study.studyKey}`;
							});
						
							row.addEventListener('click', function (e) {
								let number = e.target.parentElement.classList[1].substr(8,2);
								console.log("number : ", number);
								
								if (selectIndex === -1) {
									document.querySelector(`.selected${currentPage}${i}`).classList.add("selected");
									selectIndex = number;
								} else if (selectIndex !== i) {
									document.querySelector(`.selected${selectIndex}`).classList.remove("selected");
									document.querySelector(`.selected${number}`).classList.add("selected");
									selectIndex = number;
								}

								document.getElementById("aiFinding").innerHTML = study.aiFinding || '';
								document.getElementById("aiReport").innerHTML = study.aiReport || '';
								document.getElementById("operatorsName").innerHTML = study.operatorsName || '';
								document.getElementById("viewPosition").innerHTML = study.viewPosition || '';
								document.getElementById("bodyPart").innerHTML = study.bodyPart || '';
								document.getElementById("studyDesc").innerHTML = study.studyDesc || '';
								document.getElementById("history-patient-id").innerHTML = study.pid;
								document.getElementById("history-patient-name").innerHTML = study.pname;

								axios.get(`/study/history/${study.patientKey}`)
									.then((result) => {
										const patientHistory = result.data;
										const historyResultContainer = document.querySelector(".history-table-result");
										historyResultContainer.innerHTML = "";  // 초기화

										patientHistory.forEach((patient, i) => {
											const row = document.createElement("div");
											row.classList.add('history-table-tbody');
											if (i % 2 === 1) row.classList.add('odd');

											row.innerHTML = `
							                                    <span>${patient.modality}</span>
																<span>${patient.studyDesc}</span>
																<span>${patient.studyDate}</span>
																<span>${patient.reportStatus === 3 ? '읽지않음' : (patient.reportStatus === 5 ? '예비판독' : (patient.reportStatus === 6 ? '판독' : '알수없음'))}</span>
																<span>${patient.seriesCnt}</span>
																<span>${patient.verifyFlag === 0 ? '미요청' : (patient.verifyFlag === 1 ? '요청완료' : '알 수 없음')}</span>
															`;
											row.addEventListener('click', function () {
												location.href = `/series?studyKey=${patient.studyKey}`;
												// `/series?studyKey=${study.studyKey}`;
											});
											historyResultContainer.appendChild(row);
										});
									})
									.catch(error => console.log(error));
							});

							studyResultContainer.appendChild(row);
						});

						// '더보기' 버튼 표시 여부 결정
						const loadMoreBtn = document.getElementById("load-more-btn");
						if (currentPage + 1 < totalPages) {
							loadMoreBtn.style.display = "block";
						} else {
							loadMoreBtn.style.display = "none";
						}
					})
					.catch(error => console.log(error));
			}
		</script>
</body>

</html>